name: Build and Test C++ Examples

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch:

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        compiler: [g++-13, clang++-17]
        build_type: [Release, Debug]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake build-essential libeigen3-dev
        
        # Install specific compiler versions
        if [[ "${{ matrix.compiler }}" == "g++-13" ]]; then
          sudo apt-get install -y g++-13
        elif [[ "${{ matrix.compiler }}" == "clang++-17" ]]; then
          wget https://apt.llvm.org/llvm.sh
          chmod +x llvm.sh
          sudo ./llvm.sh 17
          sudo apt-get install -y clang++-17
        fi
    
    - name: Configure CMake
      run: |
        mkdir -p build
        cd build
        if [[ "${{ matrix.compiler }}" == "g++-13" ]]; then
          export CXX=g++-13
          export CC=gcc-13
        elif [[ "${{ matrix.compiler }}" == "clang++-17" ]]; then
          export CXX=clang++-17
          export CC=clang-17
        fi
        cmake .. -DCMAKE_BUILD_TYPE=${{ matrix.build_type }} \
                 -DCMAKE_CXX_COMPILER=$CXX
    
    - name: Build all examples
      run: |
        cd build
        make -j$(nproc)
    
    - name: List built executables
      run: |
        echo "Built executables:"
        ls -lh build/bin/
    
    - name: Run C++11 Examples
      run: |
        echo "=== Running C++11 Examples ==="
        ./build/bin/Cpp11Examples
    
    - name: Run C++14 Examples
      run: |
        echo "=== Running C++14 Examples ==="
        ./build/bin/Cpp14Examples
    
    - name: Run C++17 Examples
      run: |
        echo "=== Running C++17 Examples ==="
        ./build/bin/Cpp17Examples
    
    - name: Run C++20 Examples
      run: |
        echo "=== Running C++20 Examples ==="
        ./build/bin/Cpp20Examples
    
    - name: Run Special Member Functions Example
      run: |
        echo "=== Running Rule of 3/5/0 ==="
        ./build/bin/RuleOf3_5_0
    
    - name: Run Object Slicing and Smart Pointers Example
      run: |
        echo "=== Running Object Slicing and Smart Pointers ==="
        ./build/bin/ObjectSlicingSmartPtr
    
    - name: Run Object Slicing Prevention with C++20
      run: |
        echo "=== Running Object Slicing Prevention (C++20) ==="
        ./build/bin/ObjectSlicingCpp20
    
    - name: Run Inheritance Types Example
      run: |
        echo "=== Running Inheritance Types (Public/Private/Protected) ==="
        ./build/bin/InheritanceTypes
    
    - name: Run Dependency Injection Example
      run: |
        echo "=== Running Dependency Injection Patterns ==="
        ./build/bin/DependencyInjection
    
    - name: Run Polymorphism and RTTI Example
      run: |
        echo "=== Running Polymorphism and RTTI ==="
        ./build/bin/PolymorphismRTTI
    
    - name: Run Event-Driven Programming (Lambdas)
      run: |
        echo "=== Running Event-Driven Programming (Lambdas) ==="
        ./build/bin/EventDrivenProgramming_Lambdas
    
    - name: Run Event-Driven Programming (Inheritance)
      run: |
        echo "=== Running Event-Driven Programming (Inheritance) ==="
        ./build/bin/EventDrivenProgramming_Inheritance
    
    - name: Run Embedded Systems Programming
      run: |
        echo "=== Running Embedded Systems Programming ==="
        ./build/bin/EmbeddedSystemsProgramming
    
    - name: Run Embedded Systems (Why Avoid)
      run: |
        echo "=== Running Embedded Systems (Why Avoid) ==="
        ./build/bin/EmbeddedSystemsAvoid
    
    - name: Run ASIO and Modern C++ Concurrency Example
      run: |
        echo "=== Running ASIO vs Modern C++ Concurrency ==="
        ./build/bin/AsioAndModernCppConcurrency
    
    - name: Run Algorithm Examples
      run: |
        echo "=== Running BinarySearch ==="
        ./build/bin/BinarySearch
        
        echo "=== Running Cpp17Concurrency ==="
        ./build/bin/Cpp17Concurrency
        
        echo "=== Running DeleteNode ==="
        ./build/bin/DeleteNode
        
        echo "=== Running FindCountOfCommonNodes ==="
        ./build/bin/FindCountOfCommonNodes
        
        echo "=== Running FindFirstCommonNode ==="
        ./build/bin/FindFirstCommonNode
        
        echo "=== Running FindMaxNoOfConsecutiveOnesFromIntArray ==="
        ./build/bin/FindMaxNoOfConsecutiveOnesFromIntArray
        
        echo "=== Running FindMToLastElement ==="
        ./build/bin/FindMToLastElement
        
        echo "=== Running LambdaCaptures ==="
        ./build/bin/LambdaCaptures
        
        echo "=== Running SearchAnagramsDictionary ==="
        ./build/bin/SearchAnagramsDictionary
        
        echo "=== Running SinglyLinkedList ==="
        ./build/bin/SinglyLinkedList
        
        echo "=== Running Tuples ==="
        ./build/bin/Tuples
    
    - name: Run Feature-Specific Examples
      run: |
        echo "=== Running GenericLambdas ==="
        ./build/bin/GenericLambdas
        
        echo "=== Running StructuredBindings ==="
        ./build/bin/StructuredBindings
        
        echo "=== Running OptionalExamples ==="
        ./build/bin/OptionalExamples
        
        echo "=== Running ConceptsExamples ==="
        ./build/bin/ConceptsExamples
        
        echo "=== Running RangesExamples ==="
        ./build/bin/RangesExamples
    
    - name: Run Eigen Sensor Fusion Example
      run: |
        echo "=== Running Eigen Sensor Fusion and Particle Filter ==="
        if [ -f ./build/bin/EigenSensorFusion ]; then
          ./build/bin/EigenSensorFusion
        else
          echo "EigenSensorFusion not built (Eigen3 may not be available)"
        fi
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: executables-${{ matrix.compiler }}-${{ matrix.build_type }}
        path: build/bin/
        retention-days: 7

  build-pybind11:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        python-version: ['3.8', '3.9', '3.10', '3.11', '3.12']
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
    
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pybind11 numpy
    
    - name: Install C++ compiler
      run: |
        sudo apt-get update
        sudo apt-get install -y g++-13
    
    - name: Build pybind11 extension
      run: |
        export CXX=g++-13
        export CC=gcc-13
        c++ -O3 -Wall -shared -std=c++17 -fPIC \
            $(python3 -m pybind11 --includes) \
            src/Pybind11Example.cpp \
            -o pybind_example$(python3-config --extension-suffix)
    
    - name: Verify extension was built
      run: |
        ls -lh pybind_example*.so || ls -lh pybind_example*.pyd
    
    - name: Run pybind11 tests
      run: |
        python test_pybind.py
    
    - name: Upload pybind11 module
      uses: actions/upload-artifact@v4
      with:
        name: pybind11-module-py${{ matrix.python-version }}
        path: pybind_example*.so
        retention-days: 7
