name: Build and Test C++ Examples

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch:

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        compiler: [g++-13, clang++-17]
        build_type: [Release, Debug]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake build-essential libeigen3-dev \
          protobuf-compiler libprotobuf-dev nlohmann-json3-dev
        
        # Install specific compiler versions
        if [[ "${{ matrix.compiler }}" == "g++-13" ]]; then
          sudo apt-get install -y g++-13
        elif [[ "${{ matrix.compiler }}" == "clang++-17" ]]; then
          wget -q https://apt.llvm.org/llvm.sh || exit 1
          chmod +x llvm.sh
          sudo ./llvm.sh 17 || (sudo apt-get install -y clang-17 && ln -s /usr/bin/clang-17 /usr/bin/clang++-17)
        fi
    
    - name: Configure CMake
      run: |
        mkdir -p build
        cd build
        if [[ "${{ matrix.compiler }}" == "g++-13" ]]; then
          export CXX=g++-13
          export CC=gcc-13
        elif [[ "${{ matrix.compiler }}" == "clang++-17" ]]; then
          export CXX=clang++-17
          export CC=clang-17
        fi
        cmake .. -DCMAKE_BUILD_TYPE=${{ matrix.build_type }} \
                 -DCMAKE_CXX_COMPILER=$CXX
    
    - name: Build all examples
      run: |
        cd build
        make -j$(nproc)
    
    - name: List built executables
      run: |
        echo "Built executables:"
        ls -lh build/bin/
    
    - name: Run C++11 Examples
      run: |
        echo "=== Running C++11 Examples ==="
        ./build/bin/Cpp11Examples
    
    - name: Run C++14 Examples
      run: |
        echo "=== Running C++14 Examples ==="
        ./build/bin/Cpp14Examples
    
    - name: Run C++17 Examples
      run: |
        echo "=== Running C++17 Examples ==="
        ./build/bin/Cpp17Examples
    
    - name: Run C++20 Examples
      run: |
        echo "=== Running C++20 Examples ==="
        ./build/bin/Cpp20Examples
    
    - name: Run Special Member Functions Example
      run: |
        echo "=== Running Rule of 3/5/0 ==="
        ./build/bin/RuleOf3_5_0
    
    - name: Run Object Slicing and Smart Pointers Example
      run: |
        echo "=== Running Object Slicing and Smart Pointers ==="
        ./build/bin/ObjectSlicingSmartPtr
    
    - name: Run Object Slicing Prevention with C++20
      run: |
        echo "=== Running Object Slicing Prevention (C++20) ==="
        ./build/bin/ObjectSlicingCpp20
    
    - name: Run Inheritance Types Example
      run: |
        echo "=== Running Inheritance Types (Public/Private/Protected) ==="
        ./build/bin/InheritanceTypes
    
    - name: Run Dependency Injection Example
      run: |
        echo "=== Running Dependency Injection Patterns ==="
        ./build/bin/DependencyInjection
    
    - name: Run Polymorphism and RTTI Example
      run: |
        echo "=== Running Polymorphism and RTTI ==="
        ./build/bin/PolymorphismRTTI
    
    - name: Run Event-Driven Programming (Lambdas)
      run: |
        echo "=== Running Event-Driven Programming (Lambdas) ==="
        ./build/bin/EventDrivenProgramming_Lambdas
    
    - name: Run Event-Driven Programming (Inheritance)
      run: |
        echo "=== Running Event-Driven Programming (Inheritance) ==="
        ./build/bin/EventDrivenProgramming_Inheritance
    
    - name: Run Embedded Systems Programming
      run: |
        echo "=== Running Embedded Systems Programming ==="
        ./build/bin/EmbeddedSystemsProgramming
    
    - name: Run Embedded Systems (Why Avoid)
      run: |
        echo "=== Running Embedded Systems (Why Avoid) ==="
        ./build/bin/EmbeddedSystemsAvoid
    
    - name: Run ASIO and Modern C++ Concurrency Example
      run: |
        echo "=== Running ASIO vs Modern C++ Concurrency ==="
        ./build/bin/AsioAndModernCppConcurrency
    
    - name: Run Algorithm Examples
      run: |
        echo "=== Running BinarySearch ==="
        ./build/bin/BinarySearch
        
        echo "=== Running Cpp17Concurrency ==="
        ./build/bin/Cpp17Concurrency
        
        echo "=== Running DeleteNode ==="
        ./build/bin/DeleteNode
        
        echo "=== Running FindCountOfCommonNodes ==="
        ./build/bin/FindCountOfCommonNodes
        
        echo "=== Running FindFirstCommonNode ==="
        ./build/bin/FindFirstCommonNode
        
        echo "=== Running FindMaxNoOfConsecutiveOnesFromIntArray ==="
        ./build/bin/FindMaxNoOfConsecutiveOnesFromIntArray
        
        echo "=== Running FindMToLastElement ==="
        ./build/bin/FindMToLastElement
        
        echo "=== Running LambdaCaptures ==="
        ./build/bin/LambdaCaptures
        
        echo "=== Running SearchAnagramsDictionary ==="
        ./build/bin/SearchAnagramsDictionary
        
        echo "=== Running SinglyLinkedList ==="
        ./build/bin/SinglyLinkedList
        
        echo "=== Running Tuples ==="
        ./build/bin/Tuples
    
    - name: Run Feature-Specific Examples
      run: |
        echo "=== Running GenericLambdas ==="
        ./build/bin/GenericLambdas
        
        echo "=== Running StructuredBindings ==="
        ./build/bin/StructuredBindings
        
        echo "=== Running OptionalExamples ==="
        ./build/bin/OptionalExamples
        
        echo "=== Running ConceptsExamples ==="
        ./build/bin/ConceptsExamples
        
        echo "=== Running RangesExamples ==="
        ./build/bin/RangesExamples
    
    - name: Run Eigen Sensor Fusion Example
      run: |
        echo "=== Running Eigen Sensor Fusion and Particle Filter ==="
        if [ -f ./build/bin/EigenSensorFusion ]; then
          ./build/bin/EigenSensorFusion
        else
          echo "EigenSensorFusion not built (Eigen3 may not be available)"
        fi
    
    - name: Run Protocol Buffers Example
      run: |
        echo "=== Running Protocol Buffers Example ==="
        if [ -f ./build/bin/ProtobufExample ]; then
          ./build/bin/ProtobufExample
        else
          echo "ProtobufExample not built (Protobuf may not be available)"
        fi
    
    - name: Run Nlohmann JSON Example
      run: |
        echo "=== Running Nlohmann JSON Example ==="
        if [ -f ./build/bin/NlohmannJsonExample ]; then
          ./build/bin/NlohmannJsonExample
        else
          echo "NlohmannJsonExample not built (nlohmann_json may not be available)"
        fi
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: executables-${{ matrix.compiler }}-${{ matrix.build_type }}
        path: build/bin/
        retention-days: 7

  build-pybind11:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        python-version: ['3.8', '3.9', '3.10', '3.11', '3.12']
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
    
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pybind11 numpy
    
    - name: Install C++ compiler
      run: |
        sudo apt-get update
        sudo apt-get install -y g++-13
    
    - name: Build pybind11 extension
      run: |
        export CXX=g++-13
        export CC=gcc-13
        c++ -O3 -Wall -shared -std=c++17 -fPIC \
            $(python3 -m pybind11 --includes) \
            src/Pybind11Example.cpp \
            -o pybind_example$(python3-config --extension-suffix)
    
    - name: Verify extension was built
      run: |
        ls -lh pybind_example*.so || ls -lh pybind_example*.pyd
    
    - name: Run pybind11 tests
      run: |
        python test_pybind.py
    
    - name: Upload pybind11 module
      uses: actions/upload-artifact@v4
      with:
        name: pybind11-module-py${{ matrix.python-version }}
        path: pybind_example*.so
        retention-days: 7

  generate-pdf:
    runs-on: ubuntu-latest
    needs: [build-and-test]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Install pandoc and LaTeX
      run: |
        sudo apt-get update
        sudo apt-get install -y pandoc texlive-xetex texlive-fonts-recommended \
          texlive-latex-extra texlive-latex-recommended fonts-dejavu fonts-liberation
    
    - name: Verify pandoc installation
      run: pandoc --version
    
    - name: Generate combined markdown
      run: |
        mkdir -p pdf_output
        
        # Create combined markdown file with YAML front matter
        cat > pdf_output/ModernCppRefresherCourse_Combined.md << 'EOF'
        ---
        title: "Modern C++ Refresher Course"
        subtitle: "Comprehensive Reference - C++11 through C++23"
        author:
          - Aung K. Soe
          - Claude Sonnet 4.5 (AI Assistant)
        date: January 3, 2026
        version: 1.0.0
        repository: ${{ github.server_url }}/${{ github.repository }}
        toc: true
        toc-depth: 3
        linkcolor: blue
        urlcolor: blue
        geometry: margin=1in
        fontsize: 11pt
        documentclass: article
        mainfont: DejaVu Sans
        monofont: DejaVu Sans Mono
        header-includes: |
          \usepackage{fancyhdr}
          \pagestyle{fancy}
          \fancyhead[L]{Modern C++ Refresher Course}
          \fancyhead[R]{v1.0.0}
          \usepackage{listings}
          \usepackage{xcolor}
          \usepackage{fontspec}
          \setmainfont{DejaVu Sans}
          \setmonofont{DejaVu Sans Mono}
          \lstset{
            basicstyle=\ttfamily\small,
            breaklines=true,
            frame=single,
            numbers=left,
            numberstyle=\tiny,
            language=C++,
            showstringspaces=false,
            commentstyle=\color{gray},
            keywordstyle=\color{blue},
            stringstyle=\color{red},
            extendedchars=true,
            literate={‚ïî}{{\$\texttt{\char"2554}\$}}1 {‚ïê}{{\$\texttt{\char"2550}\$}}1 {‚ïó}{{\$\texttt{\char"2557}\$}}1 {‚ïë}{{\$\texttt{\char"2551}\$}}1 {‚ïö}{{\$\texttt{\char"255A}\$}}1 {‚ïù}{{\$\texttt{\char"255D}\$}}1
          }
        ---
        
        EOF
        
        # Add README content
        cat README.md >> pdf_output/ModernCppRefresherCourse_Combined.md
        echo -e "\n\n\\newpage\n\n" >> pdf_output/ModernCppRefresherCourse_Combined.md
        
        # Add all source files alphabetically
        for file in $(find src -name "*.cpp" -o -name "*.cppm" | sort); do
          FILENAME=$(basename "$file")
          echo "Processing: $FILENAME"
          cat >> pdf_output/ModernCppRefresherCourse_Combined.md << EOF2
        # Source Code: $FILENAME
        
        **File:** \`$file\`  
        **Repository:** [${{ github.server_url }}/${{ github.repository }}/blob/${{ github.ref_name }}/$file](${{ github.server_url }}/${{ github.repository }}/blob/${{ github.ref_name }}/$file)
        
        \`\`\`cpp
        EOF2
          cat "$file" >> pdf_output/ModernCppRefresherCourse_Combined.md
          cat >> pdf_output/ModernCppRefresherCourse_Combined.md << 'EOF3'
        
        ```
        
        \newpage
        
        EOF3
        done
        
        # Add INDEX.md as appendix
        echo -e "\n\n# Appendix: Comprehensive Index\n\n" >> pdf_output/ModernCppRefresherCourse_Combined.md
        cat INDEX.md >> pdf_output/ModernCppRefresherCourse_Combined.md
    
    - name: Check markdown file
      run: |
        echo "Checking combined markdown file..."
        ls -lh pdf_output/ModernCppRefresherCourse_Combined.md
        echo "File size: $(du -h pdf_output/ModernCppRefresherCourse_Combined.md | cut -f1)"
        echo "Line count: $(wc -l < pdf_output/ModernCppRefresherCourse_Combined.md)"
    
    - name: Generate PDF with pandoc
      run: |
        echo "Starting PDF generation..."
        pandoc pdf_output/ModernCppRefresherCourse_Combined.md \
          -o pdf_output/ModernCppRefresherCourse.pdf \
          --pdf-engine=xelatex \
          --toc \
          --toc-depth=3 \
          --number-sections \
          --highlight-style=tango \
          -V geometry:margin=1in \
          -V fontsize=11pt \
          -V linkcolor=blue \
          -V urlcolor=blue \
          --verbose \
          2>&1 | tee pandoc.log || { echo "‚ùå Pandoc failed, see log:"; cat pandoc.log; exit 1; }
    
    - name: Verify PDF was created
      run: |
        ls -lh pdf_output/ModernCppRefresherCourse.pdf
        echo "PDF size: $(du -h pdf_output/ModernCppRefresherCourse.pdf | cut -f1)"
    
    - name: Upload PDF artifact
      uses: actions/upload-artifact@v4
      with:
        name: ModernCppRefresherCourse-PDF
        path: pdf_output/ModernCppRefresherCourse.pdf
        retention-days: 90
    
    - name: Upload combined markdown
      uses: actions/upload-artifact@v4
      with:
        name: CombinedMarkdown
        path: pdf_output/ModernCppRefresherCourse_Combined.md
        retention-days: 30
    
    - name: Upload pandoc log on failure
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: PandocLog
        path: pandoc.log
        retention-days: 7
    
    - name: Set up Python for documentation update
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Update documentation for new files
      run: |
        echo "Checking for new source files and updating documentation..."
        python3 scripts/update_documentation.py
        
        # Check if INDEX_UPDATE_TEMPLATE.txt was created (new files detected)
        if [ -f INDEX_UPDATE_TEMPLATE.txt ]; then
          echo "::warning::New source files detected! Review INDEX_UPDATE_TEMPLATE.txt"
          cat INDEX_UPDATE_TEMPLATE.txt
        fi
      continue-on-error: true
    
    - name: Commit documentation updates
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        
        if git diff --quiet README.md; then
          echo "No changes to README.md"
        else
          git add README.md
          git commit -m "docs: Auto-update README.md with new source files [skip ci]"
          echo "README.md updated"
        fi
      continue-on-error: true
    
    - name: Push documentation updates
      uses: ad-m/github-push-action@master
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        branch: ${{ github.ref }}
      continue-on-error: true

  release-pdf:
    runs-on: ubuntu-latest
    needs: [generate-pdf]
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
    - name: Download PDF artifact
      uses: actions/download-artifact@v4
      with:
        name: ModernCppRefresherCourse-PDF
        path: ./
    
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          ModernCppRefresherCourse.pdf
        body: |
          ## Modern C++ Refresher Course - Version ${{ github.ref_name }}
          
          üìö **Complete PDF Documentation**
          
          This release includes the comprehensive Modern C++ Refresher Course PDF containing:
          - Complete README with all 72+ examples
          - All source code files (C++11 through C++23)
          - Comprehensive index with topic mapping
          
          **Contents:**
          - C++ Standards: C++11, C++14, C++17, C++20, C++23
          - Design Patterns: CRTP, Pimpl, NVI, SOLID, Dependency Injection
          - Real-Time & Embedded Systems
          - Safety-Critical Systems (MISRA, AUTOSAR, ISO 26262)
          - Concurrency & Parallelism
          - Memory Management & Move Semantics
          - Template Metaprogramming
          
          **Authors:**
          - Aung K. Soe
          - Claude Sonnet 4.5 (AI Assistant)
          
          üì• **Download:** Click on `ModernCppRefresherCourse.pdf` below
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
